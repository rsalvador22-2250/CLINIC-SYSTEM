<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clinic Records</title>
<link rel="icon" type="image/png" href="school logo.jpg">
<style>
body { font-family:"Segoe UI",Arial,sans-serif; background: linear-gradient(135deg,#b2f2bb,#d4edda); margin:0; padding:0; }
header { background-color:#155724; color:white; text-align:center; padding:20px 0; font-size:24px; font-weight:bold; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
.container { max-width:1200px; margin:20px auto; padding:20px; background:white; border-radius:15px; box-shadow:0 4px 12px rgba(0,0,0,0.15); }

/* Buttons */
.back-btn { background:#28a745; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; margin-bottom:15px; }
#searchInput { padding:10px 15px; border:2px solid #9ccc65; border-radius:25px; width:250px; margin-bottom:15px; }

/* Table */
.records-table { width:100%; border-collapse:collapse; margin-top:10px; }
.records-table th, .records-table td { border:1px solid #dee2e6; padding:8px; text-align:left; }
.records-table th { background:#218838; color:white; }
.records-table tr:nth-child(even){background:#f8f9fa;}
.records-table tr:hover{background:#e9ecef;}
.edit-btn { background:#ffc107; color:#212529; padding:5px 10px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.delete-btn { background:#dc3545; color:white; padding:5px 10px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.delete-btn:hover{background:#b02a37;}
.edit-btn:hover{background:#e0a800;}

/* Modal */
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
.modal-content { background:white; padding:25px 30px; border-radius:15px; max-width:700px; width:95%; position:relative; max-height:90vh; overflow-y:auto; box-shadow:0 15px 35px rgba(0,0,0,0.25); }
.modal-close { position:absolute; top:15px; right:20px; font-size:28px; color:#dc3545; cursor:pointer; }
.modal-content input, .modal-content textarea { width:100%; padding:12px; border:1px solid #28a745; border-radius:12px; margin-bottom:12px; outline:none; }
.modal-buttons { display:flex; justify-content:flex-end; gap:15px; flex-wrap:wrap; }
.save-btn{background:#28a745;color:white;padding:12px 25px;border:none;border-radius:12px;cursor:pointer;font-weight:bold;transition:0.2s;}
.cancel-btn{background:#dc3545;color:white;padding:12px 25px;border:none;border-radius:12px;cursor:pointer;font-weight:bold;transition:0.2s;}
</style>
</head>
<body>

<header>Clinic Consultation Records</header>

<div class="container">
  <button id="logoutBtn" class="back-btn">â¬… Back to Form</button>
  <button id="exportBtn" class="back-btn" style="background:#007bff;">ðŸ“¥ Export to Excel</button>
  <input type="text" id="searchInput" placeholder="ðŸ” Search by Name or Student Number">
  <div id="recordsContainer">Loading records...</div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span id="modalClose" class="modal-close">&times;</span>
    <h3 style="font-size:24px; font-weight:bold; color:#155724; margin-bottom:20px; border-bottom:2px solid #28a745; padding-bottom:10px;">Edit Consultation Record</h3>
    <form id="editForm" style="display:grid; gap:15px;">
      <div style="display:flex; gap:15px; flex-wrap:wrap;">
        <input type="text" id="editName" placeholder="Name" style="flex:1 1 45%;">
        <input type="text" id="editStudentNumber" placeholder="Student Number" style="flex:1 1 45%;">
      </div>
      <div style="display:flex; gap:15px; flex-wrap:wrap;">
        <input type="text" id="editSection" placeholder="Section" style="flex:1 1 45%;">
        <input type="date" id="editDate" style="flex:1 1 45%;">
      </div>
      <div style="display:flex; gap:15px; flex-wrap:wrap;">
        <input type="time" id="editTimeIn" style="flex:1 1 45%;">
        <input type="time" id="editTimeOut" style="flex:1 1 45%;">
      </div>
      <textarea id="editComplaints" rows="2" placeholder="Chief Complaints"></textarea>
      <textarea id="editAssessment" rows="2" placeholder="Assessment"></textarea>
      <div style="display:flex; gap:15px; flex-wrap:wrap;">
        <textarea id="editMedicine" rows="2" placeholder="Medicine" style="flex:1 1 45%;"></textarea>
        <textarea id="editIntervention" rows="2" placeholder="Intervention" style="flex:1 1 45%;"></textarea>
      </div>
      <input type="text" id="editPersonnel" placeholder="Clinic Personnel">
      <div class="modal-buttons">
        <button type="button" id="saveEditBtn" class="save-btn">ðŸ’¾ Update</button>
        <button type="button" id="cancelEditBtn" class="cancel-btn">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBhft3v9j2ooODFwL1GiBs97PvCCFuDo6U",
  authDomain: "clinicsystem-66175.firebaseapp.com",
  projectId: "clinicsystem-66175",
  storageBucket: "clinicsystem-66175.appspot.com",
  messagingSenderId: "572979094042",
  appId: "1:572979094042:web:2026805fab9c63930ae7a3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const recordsContainer = document.getElementById("recordsContainer");
const searchInput = document.getElementById("searchInput");
const logoutBtn = document.getElementById("logoutBtn");
const editModal = document.getElementById("editModal");
const modalClose = document.getElementById("modalClose");
const saveEditBtn = document.getElementById("saveEditBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const exportBtn = document.getElementById("exportBtn");

let allRecords = [];
let editingRecordId = null;

// ===== Protect page =====
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    loadRecords();
  }
});

// Logout
logoutBtn.addEventListener("click", async () => {
  await signOut(auth).catch(()=>{});
  window.location.href = "index.html";
});

// Load Firestore records
function loadRecords(){
  const q = query(collection(db,"clinicform"), orderBy("timestamp","desc"));
  onSnapshot(q, snapshot => {
    allRecords = snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
    renderRecords(allRecords);
  });
}

// Render table
function renderRecords(records){
  if(records.length===0){
    recordsContainer.innerHTML = "<p>No records found.</p>";
    return;
  }
  let html = `<table class="records-table">
      <thead>
        <tr>
          <th>Date</th><th>Name</th><th>Student #</th><th>Section</th>
          <th>Complaints</th><th>Assessment</th><th>Medicine</th>
          <th>Intervention</th><th>Personnel</th><th>Actions</th>
        </tr>
      </thead><tbody>`;
  records.forEach(r=>{
    html += `<tr>
      <td>${r.date||""}</td>
      <td>${r.name||""}</td>
      <td>${r.student_number||""}</td>
      <td>${r.section||""}</td>
      <td>${r.complaints||""}</td>
      <td>${r.assessment||""}</td>
      <td>${r.medicine||""}</td>
      <td>${r.intervention||""}</td>
      <td>${r.personnel||""}</td>
      <td>
        <button class="edit-btn" data-id="${r.id}">Edit</button>
        <button class="delete-btn" data-id="${r.id}">Delete</button>
      </td>
    </tr>`;
  });
  html += "</tbody></table>";
  recordsContainer.innerHTML = html;

  document.querySelectorAll(".delete-btn").forEach(btn=>{
    btn.onclick = ()=>deleteRecord(btn.dataset.id);
  });

  document.querySelectorAll(".edit-btn").forEach(btn=>{
    btn.onclick = ()=>openEdit(btn.dataset.id);
  });
}

// Delete record
async function deleteRecord(id){
  if(!confirm("Delete this record?")) return;
  await deleteDoc(doc(db,"clinicform",id));
  alert("Record deleted.");
}

// Open edit modal
function openEdit(id){
  const r = allRecords.find(x=>x.id===id);
  editingRecordId = id;
  document.getElementById("editName").value = r.name||"";
  document.getElementById("editStudentNumber").value = r.student_number||"";
  document.getElementById("editSection").value = r.section||"";
  document.getElementById("editDate").value = r.date||"";
  document.getElementById("editTimeIn").value = r.time_in||"";
  document.getElementById("editTimeOut").value = r.time_out||"";
  document.getElementById("editComplaints").value = r.complaints||"";
  document.getElementById("editAssessment").value = r.assessment||"";
  document.getElementById("editMedicine").value = r.medicine||"";
  document.getElementById("editIntervention").value = r.intervention||"";
  document.getElementById("editPersonnel").value = r.personnel||"";
  editModal.style.display = "flex";
}

// Save edits
saveEditBtn.onclick = async () => {
  const data = {
    name: document.getElementById("editName").value,
    student_number: document.getElementById("editStudentNumber").value,
    section: document.getElementById("editSection").value,
    date: document.getElementById("editDate").value,
    time_in: document.getElementById("editTimeIn").value,
    time_out: document.getElementById("editTimeOut").value,
    complaints: document.getElementById("editComplaints").value,
    assessment: document.getElementById("editAssessment").value,
    medicine: document.getElementById("editMedicine").value,
    intervention: document.getElementById("editIntervention").value,
    personnel: document.getElementById("editPersonnel").value
  };
  await updateDoc(doc(db,"clinicform",editingRecordId), data);
  alert("Updated successfully!");
  closeModal();
};

function closeModal(){
  editModal.style.display = "none";
}

cancelEditBtn.onclick = closeModal;
modalClose.onclick = closeModal;
editModal.onclick = e => { if(e.target===editModal) closeModal(); }

// Search filter
searchInput.addEventListener("input", ()=> {
  const term = searchInput.value.toLowerCase();
  document.querySelectorAll(".records-table tbody tr").forEach(tr=>{
    const name = tr.cells[1].textContent.toLowerCase();
    const sn = tr.cells[2].textContent.toLowerCase();
    tr.style.display = name.includes(term) || sn.includes(term) ? "" : "none";
  });
});

// Export to Excel
exportBtn.addEventListener("click", ()=>{
  const term = searchInput.value.toLowerCase();
  const filtered = allRecords.filter(r=>{
    return r.name.toLowerCase().includes(term) || r.student_number.toLowerCase().includes(term);
  });

  if(filtered.length===0){ alert("No records to export!"); return; }

  const data = filtered.map(r=>({
    Date: r.date||"",
    Name: r.name||"",
    "Student Number": r.student_number||"",
    Section: r.section||"",
    Complaints: r.complaints||"",
    Assessment: r.assessment||"",
    Medicine: r.medicine||"",
    Intervention: r.intervention||"",
    Personnel: r.personnel||""
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Clinic Records");
  XLSX.writeFile(wb, "ClinicRecords.xlsx");
});
</script>

</body>
</html>
